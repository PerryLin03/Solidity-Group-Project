<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liquidation Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 基本樣式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .nav-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .nav-button:hover {
            background-color: #218838;
        }

        .candidate-list {
            margin: 20px 0;
        }

        .candidate-item {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .candidate-item p {
            margin: 5px 0;
        }

        .liquidate-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .liquidate-button:hover {
            background-color: #c82333;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Liquidation Page</h1>

        <!-- 返回首頁導航按鈕 -->
        <a href="1 index.html" class="nav-button">Home</a>

        <!-- 清算候選者列表 -->
        <div class="candidate-list" id="candidate-list">
            <p>Loading liquidation candidates...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>
        const contractAddress = '0xfB5AF694DE274d4378B342F07b2907cc6BdDf253'; // 替換為你的合約地址
        const abi = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "priceFeed",
                        "type": "address"
                    }
                ],
                "name": "AssetPriceFeedUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "borrowAsset",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    }
                ],
                "name": "Borrow",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "Deposit",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "borrower",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "borrowAsset",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "liquidationAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "liquidatedCollateral",
                        "type": "uint256"
                    }
                ],
                "name": "Liquidation",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "Repay",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "Withdraw",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "BORROW_RATE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "BTC_USD_PRICE_FEED",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "DEPOSIT_RATE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ETH",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ETH_USD_PRICE_FEED",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "LIQUIDATION_BONUS",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "LIQUIDATION_THRESHOLD",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "USDC",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "USDC_USD_PRICE_FEED",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "USDT",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "USDT_USD_PRICE_FEED",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "WBTC",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "assetInfo",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "internalType": "contract AggregatorV3Interface",
                        "name": "priceFeed",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalDeposits",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalBorrows",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "reserveFactor",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "lastUpdateTimestamp",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "borrowAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "borrowAmount",
                        "type": "uint256"
                    }
                ],
                "name": "borrow",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getAccruedInterest",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    }
                ],
                "name": "getAssetPrice",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    }
                ],
                "name": "getAssetPriceFeed",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getCollateralValue",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "borrowAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "collateralAmount",
                        "type": "uint256"
                    }
                ],
                "name": "getMaxBorrowAmount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "tokenAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "priceFeedAddress",
                        "type": "address"
                    }
                ],
                "name": "initializeAsset",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    }
                ],
                "name": "isAssetSupported",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "borrower",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "borrowAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    }
                ],
                "name": "isLiquidatable",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "borrower",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "borrowAsset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "collateralAsset",
                        "type": "address"
                    }
                ],
                "name": "liquidate",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "repay",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "priceFeed",
                        "type": "address"
                    }
                ],
                "name": "setAssetPriceFeed",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "userBorrows",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "lastUpdateTimestamp",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "userDeposits",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "lastUpdateTimestamp",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "asset",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ]

        let contract;
        let web3;

        // 初始化合約
        async function initContract() {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    contract = new web3.eth.Contract(abi, contractAddress);
                    loadLiquidationCandidates();
                } catch (error) {
                    console.error("Error connecting to MetaMask: ", error);
                    alert("Please allow access to MetaMask.");
                }
            } else {
                alert("MetaMask is not installed. Please install MetaMask to use this feature.");
            }
        }

        // 加載清算候選者
        async function loadLiquidationCandidates() {
            try {
                // 獲取所有借款人的地址
                const borrowerAddresses = await getBorrowerAddresses();

                const candidateListElement = document.getElementById('candidate-list');
                candidateListElement.innerHTML = '';

                for (const borrower of borrowerAddresses) {
                    // 檢查每個借款人是否可被清算
                    const isLiquidatable = await contract.methods.isLiquidatable(borrower, borrowAssetAddress, collateralAssetAddress).call();

                    if (isLiquidatable) {
                        // 獲取借款人的借款和抵押資訊
                        const userBorrow = await contract.methods.userBorrows(borrowAssetAddress, borrower).call();
                        const userDeposit = await contract.methods.userDeposits(collateralAssetAddress, borrower).call();

                        const borrowAmount = web3.utils.fromWei(userBorrow.amount, 'ether');
                        const collateralAmount = web3.utils.fromWei(userDeposit.amount, 'ether');

                        // 創建候選者項目
                        const candidateItem = document.createElement('div');
                        candidateItem.className = 'candidate-item';

                        candidateItem.innerHTML = `
                            <p><strong>Borrower Address:</strong> ${borrower}</p>
                            <p><strong>Borrow Amount:</strong> ${borrowAmount} ETH</p>
                            <p><strong>Collateral Amount:</strong> ${collateralAmount} ETH</p>
                            <button class="liquidate-button" data-borrower="${borrower}">Liquidate</button>
                        `;

                        candidateListElement.appendChild(candidateItem);
                    }
                }

                if (candidateListElement.innerHTML === '') {
                    candidateListElement.innerHTML = '<p>No liquidation candidates at the moment.</p>';
                }

            } catch (error) {
                console.error("Error loading liquidation candidates: ", error);
            }
        }

        // 獲取借款人地址列表（需根據你的合約實現）
        async function getBorrowerAddresses() {
            // 這是一個佔位函數。
            // 你需要實現一種方法從合約中獲取所有借款人地址。
            // 例如，你可以在合約中維護一個借款人地址的數組，或者透過事件日誌獲取。
            return []; // 返回借款人地址的數組
        }

        // 監聽清算按鈕點擊事件
        document.addEventListener('click', async function(event) {
            if (event.target && event.target.classList.contains('liquidate-button')) {
                const borrower = event.target.getAttribute('data-borrower');
                await liquidateBorrower(borrower);
            }
        });

        // 清算借款人
        async function liquidateBorrower(borrower) {
            const accounts = await web3.eth.getAccounts();
            const userAddress = accounts[0];

            try {
                // 調用合約的 liquidate 函數
                await contract.methods.liquidate(borrower, borrowAssetAddress, collateralAssetAddress).send({ from: userAddress, value: liquidationAmountInWei });
                alert('Liquidation successful!');
                // 重新加載候選者列表
                loadLiquidationCandidates();
            } catch (error) {
                console.error("Error during liquidation: ", error);
                alert('Failed to liquidate borrower.');
            }
        }

        // 資產地址（替換為你的實際資產地址）
        const borrowAssetAddress = '0x...'; // 借款人所借的資產地址
        const collateralAssetAddress = '0x...'; // 抵押資產地址

        // 計算清算所需金額（根據你的合約邏輯）
        let liquidationAmountInWei;

        // 初始化合約並計算清算金額
        window.addEventListener('load', async () => {
            await initContract();
            // 根據需要計算 liquidationAmountInWei
            // 例如：
            // liquidationAmountInWei = await contract.methods.calculateLiquidationAmount(borrower).call();
        });

    </script>

</body>
</html>
